# 需求分析：滑动误触修复与笔记功能增强

## 📋 需求概述

### Bug修复
1. **滑动误触问题**：在文件夹内部上下滑动页面时，容易触发选中笔记，导致用户体验不佳（主要是移动端）
2. **任务详情拖拽冲突**：在任务详情页面，用鼠标点击并拖动选中文字时，会触发任务清单页面对任务的拖动

### 功能需求
1. **全局查找增强**：在一个页面内如果找到多项，可以进行上下切换
2. **笔记查找与替换**：笔记页面加入查找与替换功能
3. **表格支持**：笔记页面支持插入表格，功能上参考iOS备忘录的表格
4. **笔记统计信息**：笔记页面底部统计字数、创建于XXX、最后编辑于XXX

---

## 🔍 需求详细分析

### Bug 1：滑动误触问题

#### 问题根源
在 `MindNoteManager.tsx` 中，笔记卡片使用了以下事件处理：
- `onTouchStart` / `onMouseDown`：用于长按进入选择模式（500ms延迟）
- `onTouchEnd` / `onMouseUp`：用于取消长按定时器

**问题**：当用户在移动端滑动页面时，`touchstart` 事件会在滑动开始时触发，如果用户滑动速度较慢或停顿，可能触发500ms的长按定时器，导致误选中笔记。

#### 解决方案
需要区分**点击/长按**和**滑动**操作：
1. **检测滑动距离**：在 `touchstart` 和 `touchmove` 之间计算移动距离
2. **滑动阈值**：如果移动距离超过阈值（如10-15px），则取消长按定时器
3. **时间窗口**：在 `touchmove` 事件中检测，如果检测到滑动，立即清除定时器

#### 技术实现要点
- 在 `handleTouchStart` 中记录初始触摸位置
- 添加 `handleTouchMove` 处理函数，检测滑动距离
- 如果检测到滑动，清除长按定时器
- 确保滑动操作不会触发选择模式

---

### Bug 2：任务详情拖拽冲突

#### 问题根源
在 `TodoDetail.tsx` 任务详情弹窗中，当用户用鼠标点击并拖动选中文字时，`mousedown` 和 `touchstart` 事件会冒泡到父级的 `DndContext`（任务列表的拖拽上下文），导致触发任务拖动。

**问题场景**：
- 用户在任务详情弹窗中选中文字（如描述字段）
- 拖拽选中文字时，触发了任务列表的拖拽功能
- 导致任务被意外拖动，影响用户体验

#### 解决方案
在 `TodoDetail` 弹窗的最外层容器上阻止拖拽相关事件的传播：
1. **阻止 `mousedown` 事件传播**：`@dnd-kit` 的 `MouseSensor` 使用 `mousedown` 检测拖拽
2. **阻止 `touchstart` 事件传播**：`@dnd-kit` 的 `TouchSensor` 使用 `touchstart` 检测拖拽
3. **阻止 `dragstart` 事件传播**：防止原生拖拽事件传播

#### 技术实现要点
- 在 `TodoDetail` 的最外层容器（遮罩层和内容容器）上添加事件处理器
- 使用 `e.stopPropagation()` 阻止事件冒泡到父级
- 确保弹窗内部的正常交互不受影响（事件已在弹窗内部处理）

#### 实现状态
✅ **已修复**：已在 `src/components/TodoDetail.tsx` 中添加事件处理器，阻止拖拽事件传播

---

### 需求1：全局查找结果切换

#### 功能描述
在全局搜索结果中，如果在一个页面内找到多个匹配项，用户可以通过上下箭头键或按钮在结果之间切换。

#### 可行性分析
✅ **高度可行**

**当前实现**：
- 全局搜索在 `DashboardPage` 中实现（`src/app/dashboard/page.tsx`）
- 搜索结果通过 `searchResults` 状态管理
- 点击结果会跳转到笔记详情页（`/notes/[id]`）

**需要实现**：
1. **结果高亮与导航**：
   - 在搜索结果列表中，当前选中的结果高亮显示
   - 支持键盘导航（上下箭头键）
   - 支持鼠标点击切换

2. **页面内结果切换**（如果跳转到笔记详情页）：
   - 在笔记详情页中，如果通过搜索进入，需要支持在页面内多个匹配项之间切换
   - 使用 `search` query参数传递搜索关键词（已实现）
   - 需要实现"下一个"和"上一个"按钮/快捷键

3. **状态管理**：
   - 记录当前匹配项的索引
   - 在匹配项之间切换时，滚动到对应位置并高亮

#### 技术实现要点
- 在搜索结果列表中添加键盘事件监听（上下箭头键）
- 在笔记详情页中，解析所有匹配项的位置
- 实现"下一个"/"上一个"按钮，支持快捷键（如 `Ctrl+G` / `F3`）
- 使用 `scrollIntoView` 和文本高亮来定位匹配项

---

### 需求2：笔记查找与替换

#### 功能描述
在笔记编辑页面（`NoteManager`）中添加查找与替换功能，类似常见编辑器的查找替换功能。

#### 可行性分析
✅ **高度可行**

**当前实现**：
- 笔记编辑器使用 `Textarea` 组件（`src/components/NoteManager.tsx`）
- 支持 Markdown 格式
- 已有预览模式

**需要实现**：
1. **查找功能**：
   - 快捷键：`Ctrl+F`（PC）或工具栏按钮
   - 查找输入框，实时高亮匹配项
   - 显示匹配项数量（如 "1/5"）
   - 支持上下切换匹配项（`Enter` / `Shift+Enter` 或上下箭头）

2. **替换功能**：
   - 快捷键：`Ctrl+H`（PC）或工具栏按钮
   - 替换输入框
   - 支持"替换"（单个）和"全部替换"
   - 替换后自动定位到下一个匹配项

3. **UI设计**：
   - 查找/替换面板可以固定在编辑器顶部或底部
   - 移动端使用工具栏按钮触发
   - 支持关闭按钮（`Esc`）

#### 技术实现要点
- 使用 `Textarea` 的 `selectionStart` 和 `selectionEnd` 来定位文本
- 使用正则表达式进行文本匹配（考虑大小写敏感选项）
- 实现文本高亮（可以使用 `mark` 标签或自定义样式）
- 替换时直接操作 `content` 状态，更新文本内容

---

### 需求3：表格支持（参考iOS备忘录）

#### 功能描述
在笔记编辑器中支持插入表格，功能参考iOS备忘录的表格实现。

#### 可行性分析
⚠️ **中等复杂度**

**iOS备忘录表格特性**：
- 点击插入表格按钮，插入一个2x2的表格
- 支持添加行/列
- 支持删除行/列
- 单元格可以编辑
- 表格在Markdown中渲染为HTML表格

**当前实现**：
- 笔记编辑器使用 `Textarea`（纯文本输入）
- 支持 Markdown 渲染（`MarkdownRenderer`）
- Markdown 支持表格语法（`| 列1 | 列2 |`）

**需要实现**：
1. **表格插入**：
   - 工具栏按钮"插入表格"
   - 插入标准 Markdown 表格语法（2x2）
   - 光标定位到第一个单元格

2. **表格编辑增强**（可选，较复杂）：
   - 在编辑模式下，表格显示为可编辑的HTML表格
   - 支持添加/删除行/列
   - 支持单元格编辑
   - 编辑完成后，将HTML表格转换回Markdown格式

3. **简化方案**（推荐）：
   - 插入 Markdown 表格语法
   - 用户手动编辑表格内容
   - 预览模式下正确渲染表格
   - 提供表格编辑辅助工具（如快速添加行）

#### 技术实现要点
- **方案A（简单）**：只插入 Markdown 表格语法，用户手动编辑
- **方案B（复杂）**：实现表格编辑器组件，支持可视化编辑
- 推荐先实现方案A，后续可扩展为方案B

---

### 需求4：笔记统计信息

#### 功能描述
在笔记编辑页面底部显示：
- 字数统计
- 创建时间（创建于XXX）
- 最后编辑时间（最后编辑于XXX）

#### 可行性分析
✅ **高度可行**

**当前实现**：
- 笔记数据包含 `created_at` 和 `updated_at` 字段
- 笔记编辑器在 `NoteManager` 组件中

**需要实现**：
1. **字数统计**：
   - 统计 `content` 的字符数（中文字符按1个计算）
   - 实时更新（在 `content` 变化时重新计算）

2. **时间显示**：
   - 格式化 `created_at` 和 `updated_at`
   - 使用友好的时间格式（如"2024年1月20日 14:30"或相对时间"2小时前"）

3. **UI位置**：
   - 固定在编辑器底部
   - 使用较小的字体和 muted 颜色
   - 移动端可能需要调整布局

#### 技术实现要点
- 使用 `useMemo` 计算字数（避免频繁计算）
- 使用日期格式化库（如 `date-fns`）或自定义格式化函数
- 在编辑器底部添加统计信息栏

---

## 🔗 需求关联性分析

### 关联关系图

```
Bug修复（滑动误触）
  └─ 独立需求，不影响其他功能

需求1（全局查找切换）
  └─ 与需求2（笔记查找）有相似性
      └─ 可以共享查找逻辑和UI组件

需求2（笔记查找替换）
  └─ 独立功能，但可以复用需求1的查找逻辑

需求3（表格支持）
  └─ 独立功能，不影响其他需求

需求4（统计信息）
  └─ 独立功能，不影响其他需求
```

### 实现优先级建议

1. **P0（必须）**：Bug修复（滑动误触）
2. **P1（高优先级）**：需求4（统计信息）- 实现简单，用户体验提升明显
3. **P2（中优先级）**：需求2（笔记查找替换）- 核心编辑功能
4. **P3（中优先级）**：需求1（全局查找切换）- 增强搜索体验
5. **P4（低优先级）**：需求3（表格支持）- 功能较复杂，可先实现简化版

### 技术依赖关系

- **需求1和需求2**：可以共享查找相关的工具函数和UI组件
- **需求4**：需要访问笔记的 `created_at` 和 `updated_at` 字段（已有）
- **需求3**：需要扩展 Markdown 渲染器以支持表格（基础支持已有）

---

## 📝 实现建议

### 1. Bug修复实现步骤
1. 在 `MindNoteManager.tsx` 中添加触摸位置跟踪
2. 实现 `handleTouchMove` 函数，检测滑动距离
3. 如果检测到滑动，清除长按定时器
4. 测试移动端滑动体验

### 2. 功能需求实现步骤
1. **需求4（统计信息）**：最简单，先实现
2. **需求2（查找替换）**：核心功能，优先实现
3. **需求1（全局查找切换）**：可以复用需求2的查找逻辑
4. **需求3（表格支持）**：最后实现，可以先做简化版

### 3. 代码组织建议
- 创建 `src/lib/search-utils.ts`：共享查找相关工具函数
- 创建 `src/components/FindReplaceDialog.tsx`：查找替换对话框组件
- 创建 `src/components/NoteStats.tsx`：笔记统计信息组件
- 创建 `src/components/TableEditor.tsx`：表格编辑器组件（可选）

---

## ✅ 验收标准

### Bug修复

#### Bug 1：滑动误触
- [ ] 在移动端滑动页面时，不会误触发笔记选中
- [ ] 长按功能仍然正常工作（500ms延迟）
- [ ] PC端点击和拖拽功能不受影响

#### Bug 2：任务详情拖拽冲突
- [x] 在任务详情页面选中文字时，不会触发任务拖动
- [x] 任务详情弹窗内部的交互正常（输入、选择等）
- [x] 任务列表的拖拽功能仍然正常工作

### 需求1：全局查找切换
- [ ] 在搜索结果中可以使用上下箭头键切换
- [ ] 在笔记详情页中，如果通过搜索进入，可以切换页面内的匹配项
- [ ] 显示当前匹配项位置（如 "2/5"）
- [ ] 切换时自动滚动到匹配项位置并高亮

### 需求2：笔记查找替换
- [ ] 支持 `Ctrl+F` 快捷键打开查找面板
- [ ] 支持 `Ctrl+H` 快捷键打开替换面板
- [ ] 实时高亮所有匹配项
- [ ] 支持上下切换匹配项
- [ ] 支持单个替换和全部替换
- [ ] 移动端通过工具栏按钮触发

### 需求3：表格支持
- [ ] 支持插入2x2表格（Markdown格式）
- [ ] 表格在预览模式下正确渲染
- [ ] （可选）支持可视化表格编辑

### 需求4：统计信息
- [ ] 显示字数统计（实时更新）
- [ ] 显示创建时间（友好格式）
- [ ] 显示最后编辑时间（友好格式）
- [ ] 在编辑器底部固定显示

---

## 📚 参考资料

- iOS备忘录表格交互设计
- 常见编辑器的查找替换功能（VS Code, Notion等）
- Markdown表格语法规范
- 移动端触摸事件处理最佳实践
