# 笔记导出功能需求

> **状态**: ✅ 已完成  
> **完成时间**: 2024-01-XX  
> **相关任务**: Task 5.1 in `docs/tasks/NOTE_ENHANCEMENT_TASKS.md`

## 📋 需求概述

实现笔记导出功能，支持用户批量选择笔记和文件夹进行导出，导出为压缩包格式。

---

## 🎯 功能需求

### 1. 导出入口
- 在笔记管理页面（`NoteManager`）添加"导出"按钮
- 点击后弹出导出选择对话框

### 2. 导出选择对话框

#### 2.1 对话框结构
- **位置**：弹窗形式，居中显示
- **大小**：响应式设计，移动端全屏，桌面端最大宽度 800px
- **标题**：导出笔记

#### 2.2 文件夹和笔记列表
- **默认状态**：所有文件夹默认展开，显示其下的所有笔记
- **折叠功能**：文件夹左侧有展开/折叠图标，支持点击切换
- **层级结构**：
  - 文件夹（可折叠）
    - 笔记1
    - 笔记2
    - ...
  - 未分类笔记（如果有）

#### 2.3 选择功能

**全选功能**：
- 对话框顶部有"全选"复选框
- 点击后选中所有笔记（包括所有文件夹下的笔记）
- 再次点击取消全选

**文件夹选择**：
- 文件夹左侧有复选框
- 点击文件夹复选框：
  - 选中该文件夹下的所有笔记
  - 如果文件夹已折叠，展开文件夹
  - 再次点击取消选中该文件夹下的所有笔记
- 文件夹复选框状态：
  - 全选：文件夹下所有笔记都被选中
  - 部分选中：文件夹下部分笔记被选中（显示为半选状态）
  - 未选中：文件夹下没有笔记被选中

**笔记选择**：
- 每个笔记左侧有复选框
- 支持单独选择单个笔记
- 笔记选中状态不影响文件夹的选中状态（除非文件夹下所有笔记都被选中）

#### 2.4 导出按钮
- 对话框底部有"导出"按钮
- 显示已选中的笔记数量（如"导出 (5 个笔记)"）
- 如果没有选中任何笔记，按钮禁用
- 点击后开始导出流程

---

## 🔧 技术实现要点

### 1. 数据结构
- 需要获取所有文件夹及其下的笔记
- 文件夹结构：
  ```typescript
  interface Folder {
    id: string;
    name: string;
    notes: Note[];
  }
  
  interface Note {
    id: string;
    title: string;
    content: string;
    folder_id: string | null;
    created_at: string;
    updated_at: string;
  }
  ```

### 2. 状态管理
- 使用 `useState` 管理：
  - 文件夹展开/折叠状态（`expandedFolders: Set<string>`）
  - 笔记选中状态（`selectedNotes: Set<string>`）
  - 文件夹选中状态（用于显示半选状态）

### 3. 导出逻辑
- 使用 `jszip` 库创建压缩包
- 使用 `file-saver` 库下载文件
- 导出规则：
  - **选中文件夹**：以文件夹名作为压缩包内的文件夹名，该文件夹下的所有笔记放入该文件夹
  - **选中单个笔记**：
    - 如果笔记属于某个选中的文件夹，放入该文件夹的压缩包文件夹中
    - 如果笔记不属于任何文件夹或文件夹未选中，放入根目录
  - **多个文件夹**：如果选中了多个文件夹，每个文件夹创建一个独立的压缩包文件夹
  - **文件命名**：笔记文件以 `笔记标题.md` 命名，如果标题为空则使用 `未命名笔记_时间戳.md`

### 4. 导出格式
- 导出为 ZIP 压缩包
- 压缩包内文件格式：Markdown（`.md`）
- 文件内容：笔记的 `content` 字段
- 文件结构示例：
  ```
  notes_export_20240120.zip
  ├── 工作/
  │   ├── 会议记录1.md
  │   └── 会议记录2.md
  ├── 学习/
  │   └── 读书笔记1.md
  └── 未分类笔记1.md
  ```

### 5. UI 组件
- 创建 `ExportDialog` 组件
- 使用 `Dialog` 组件（Radix UI 或自定义）
- 使用 `Checkbox` 组件
- 使用 `ChevronDown` / `ChevronRight` 图标表示展开/折叠

---

## 📝 交互流程

### 1. 打开导出对话框
```
用户点击"导出"按钮
  ↓
显示导出对话框
  ↓
加载所有文件夹和笔记（默认展开）
  ↓
显示文件夹和笔记列表
```

### 2. 选择笔记
```
用户点击文件夹复选框
  ↓
选中/取消选中该文件夹下的所有笔记
  ↓
更新文件夹复选框状态（全选/半选/未选）
```

### 3. 导出流程
```
用户点击"导出"按钮
  ↓
验证是否有选中的笔记
  ↓
遍历选中的笔记，按文件夹分组
  ↓
创建 ZIP 压缩包
  ↓
为每个文件夹创建文件夹（如果该文件夹有选中的笔记）
  ↓
将笔记内容写入 Markdown 文件
  ↓
下载压缩包
  ↓
显示导出成功提示
  ↓
关闭对话框
```

---

## ✅ 验收标准

### 功能验收
- [x] 点击导出按钮后，正确显示导出对话框
- [x] 所有文件夹默认展开，显示其下的笔记
- [x] 文件夹可以折叠/展开
- [x] 全选功能正常工作
- [x] 文件夹复选框可以选中/取消选中该文件夹下的所有笔记
- [x] 文件夹复选框正确显示全选/半选/未选状态
- [x] 单个笔记可以单独选中/取消选中
- [x] 导出按钮显示正确的选中数量
- [x] 没有选中笔记时，导出按钮禁用
- [x] 导出后生成正确的 ZIP 压缩包
- [x] 压缩包内文件结构正确（文件夹和笔记）
- [x] 笔记内容正确导出为 Markdown 格式
- [x] 文件命名正确（笔记标题或默认名称）

### UI/UX 验收
- [x] 对话框响应式设计，移动端和桌面端显示正常
- [x] 列表项有合适的间距和视觉层次
- [x] 复选框状态清晰可见
- [x] 展开/折叠图标清晰
- [x] 加载状态显示（如果有）
- [x] 导出进度提示（显示导出中状态）

### 边界情况
- [x] 空文件夹处理（不显示或显示为空）
- [x] 未分类笔记处理（显示在列表顶部或单独分组）
- [x] 笔记标题为空时的文件命名
- [x] 大量笔记导出时的性能（使用异步处理）
- [x] 导出失败时的错误提示

---

## 🔗 相关文件

### 已创建的文件
- ✅ `src/components/ExportDialog.tsx` - 导出对话框组件
- ✅ `src/components/ui/checkbox.tsx` - Checkbox UI 组件（支持 indeterminate 状态）

### 已修改的文件
- ✅ `src/components/NoteManager.tsx` - 添加导出按钮和集成导出对话框

---

## 📊 优先级

**优先级**: 🟡 P2（中优先级）

**预估时间**: 4-6 小时

**状态**: ✅ 已完成

**完成时间**: 2024-01-XX

**依赖**: 
- 需要能够获取所有文件夹和笔记的数据接口
- `jszip` 和 `file-saver` 库（已安装）

---

## 🚀 实现状态

### ✅ Phase 1: 基础功能（已完成）
1. ✅ 创建 `ExportDialog` 组件框架
2. ✅ 实现文件夹和笔记列表展示
3. ✅ 实现展开/折叠功能

### ✅ Phase 2: 选择功能（已完成）
4. ✅ 实现全选功能
5. ✅ 实现文件夹选择功能
6. ✅ 实现单个笔记选择功能
7. ✅ 实现复选框状态管理（全选/半选/未选）

### ✅ Phase 3: 导出功能（已完成）
8. ✅ 实现导出逻辑（ZIP 压缩包创建）
9. ✅ 实现文件结构组织（按文件夹分组）
10. ✅ 实现文件下载

### ✅ Phase 4: 优化（已完成）
11. ✅ 添加加载状态
12. ✅ 添加错误处理
13. ✅ 优化大量笔记导出的性能（异步处理）
14. ✅ 添加导出进度提示（导出中状态）

---

## 📝 注意事项

1. **性能考虑**：
   - 如果笔记数量很大，考虑虚拟滚动
   - 导出大量笔记时，考虑分批处理或显示进度条

2. **用户体验**：
   - 导出成功后给出明确提示
   - 导出失败时给出错误信息
   - 考虑添加"取消导出"功能（如果导出时间较长）

3. **数据安全**：
   - 确保只导出当前用户自己的笔记
   - 验证权限（RLS 策略）

4. **文件命名**：
   - 处理特殊字符（如 `/`、`\`、`:` 等）
   - 处理文件名长度限制
   - 处理重复文件名（添加序号）

5. **移动端适配**：
   - 对话框在移动端全屏显示
   - 触摸友好的复选框大小
   - 合适的字体大小和间距
