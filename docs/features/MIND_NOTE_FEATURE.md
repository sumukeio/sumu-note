# æ€ç»´ç¬”è®°åŠŸèƒ½è®¾è®¡æ–‡æ¡£

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æ€ç»´ç¬”è®°æ˜¯ä¸€ä¸ªç±»ä¼¼ Workflowy/Roam Research çš„å¤§çº²ç¼–è¾‘å™¨ï¼Œæ”¯æŒæ— é™å±‚çº§çš„èŠ‚ç‚¹ç»“æ„ã€å¯Œæ–‡æœ¬æ ¼å¼åŒ–ã€æ‹–æ‹½é‡æ’å’Œæ–‡æ¡£å†…åµŒã€‚

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. å¤§çº²ç»“æ„
- **æ— é™å±‚çº§**ï¼šæ”¯æŒä»»æ„æ·±åº¦çš„çˆ¶å­èŠ‚ç‚¹å…³ç³»
- **æ ‘å½¢ç»“æ„**ï¼šæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥æœ‰å¤šä¸ªå­èŠ‚ç‚¹
- **èŠ‚ç‚¹å†…å®¹**ï¼šçº¯æ–‡æœ¬ + æ ¼å¼åŒ–ï¼ˆåŠ ç²—ã€é«˜äº®è‰²ï¼‰

### 2. æ–‡æœ¬æ ¼å¼åŒ–
- **åŠ ç²—**ï¼š`**æ–‡æœ¬**` æˆ–å¿«æ·é”® `Ctrl/Cmd + B`
- **é«˜äº®è‰²**ï¼š`==æ–‡æœ¬==` æˆ–é€šè¿‡å·¥å…·æ é€‰æ‹©é¢œè‰²
- **çº¯æ–‡æœ¬**ï¼šé»˜è®¤æ¨¡å¼

### 3. å¿«æ·é”®ç³»ç»Ÿ

#### ç”µè„‘ç«¯
- **Tab**ï¼šåˆ›å»ºå­èŠ‚ç‚¹ï¼ˆä¸‹ä¸€çº§ï¼‰
- **Enter**ï¼šåˆ›å»ºåŒçº§èŠ‚ç‚¹ï¼ˆå…„å¼ŸèŠ‚ç‚¹ï¼‰
- **Shift + Tab**ï¼šå–æ¶ˆç¼©è¿›ï¼ˆæå‡å±‚çº§ï¼‰
- **Alt + .**ï¼šå…¨éƒ¨å±•å¼€/æŠ˜å 
- **Ctrl/Cmd + B**ï¼šåŠ ç²—é€‰ä¸­æ–‡æœ¬
- **Ctrl/Cmd + K**ï¼šé«˜äº®é€‰ä¸­æ–‡æœ¬

#### æ‰‹æœºç«¯
- **é€‰ä¸­èŠ‚ç‚¹**ï¼šç‚¹å‡»ä»»æ„èŠ‚ç‚¹ï¼Œåº•éƒ¨è‡ªåŠ¨å¼¹å‡ºå·¥å…·æ 
- **ç§»åŠ¨/æ”¹å˜å±‚çº§**ï¼šé•¿æŒ‰èŠ‚ç‚¹æ‹–æ‹½åˆ°ç›®æ ‡ä½ç½®
  - æ‹–åˆ°èŠ‚ç‚¹ä¸Šæ–¹ â†’ å˜å­èŠ‚ç‚¹
  - æ‹–åˆ°èŠ‚ç‚¹æ—è¾¹ â†’ å˜åŒçº§
- **ç¼–è¾‘æ–‡å­—**ï¼šåŒå‡»èŠ‚ç‚¹æˆ–ç‚¹å‡»å·¥å…·æ "ç¼–è¾‘"æŒ‰é’®
- **æ¢è¡Œï¼ˆEnterï¼‰**ï¼šé”®ç›˜å›è½¦ç›´æ¥ç”ŸæˆåŒçº§èŠ‚ç‚¹
- **ç¼©è¿›/å‡çº§**ï¼šå·¥å…·æ æä¾›ã€Œå‘å³ç®­å¤´ï¼ˆç¼©è¿›ï¼‰ã€å’Œã€Œå‘å·¦ç®­å¤´ï¼ˆå‡çº§ï¼‰ã€æŒ‰é’®

### 4. èŠ‚ç‚¹æ‹–æ‹½
- æ”¯æŒæ‹–æ‹½èŠ‚ç‚¹æ”¹å˜å±‚çº§æˆ–é¡ºåº
- ä½¿ç”¨ `@dnd-kit` å®ç°æµç•…æ‹–æ‹½ä½“éªŒ
- æ‹–æ‹½æ—¶æ˜¾ç¤ºè§†è§‰åé¦ˆ

### 5. æ–‡æ¡£å†…åµŒ
- åœ¨èŠ‚ç‚¹ä¸­æ’å…¥å¦ä¸€ç¯‡æ€ç»´ç¬”è®°
- è¯­æ³•ï¼š`[[mind_note_id|æ˜¾ç¤ºåç§°]]`
- ç‚¹å‡»å†…åµŒç¬”è®°å¯è·³è½¬æˆ–å±•å¼€é¢„è§ˆ

## ğŸ—‚ï¸ æ•°æ®æ¨¡å‹è®¾è®¡

### æ•°æ®åº“è¡¨ï¼š`mind_notes`

```sql
CREATE TABLE mind_notes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  title TEXT NOT NULL,  -- æ€ç»´ç¬”è®°æ ‡é¢˜
  root_node_id UUID,    -- æ ¹èŠ‚ç‚¹ IDï¼ˆè‡ªå¼•ç”¨ï¼‰
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  is_deleted BOOLEAN DEFAULT FALSE
);

CREATE TABLE mind_note_nodes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  mind_note_id UUID NOT NULL REFERENCES mind_notes(id) ON DELETE CASCADE,
  parent_id UUID REFERENCES mind_note_nodes(id) ON DELETE CASCADE,  -- NULL è¡¨ç¤ºæ ¹èŠ‚ç‚¹
  content TEXT NOT NULL,  -- èŠ‚ç‚¹å†…å®¹ï¼ˆæ”¯æŒæ ¼å¼åŒ–æ ‡è®°ï¼‰
  order_index INTEGER NOT NULL DEFAULT 0,  -- åŒçº§èŠ‚ç‚¹æ’åº
  is_expanded BOOLEAN DEFAULT TRUE,  -- æ˜¯å¦å±•å¼€ï¼ˆç”¨äºæŠ˜å åŠŸèƒ½ï¼‰
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_mind_notes_user_id ON mind_notes(user_id);
CREATE INDEX idx_mind_notes_updated_at ON mind_notes(updated_at DESC);
CREATE INDEX idx_mind_note_nodes_mind_note_id ON mind_note_nodes(mind_note_id);
CREATE INDEX idx_mind_note_nodes_parent_id ON mind_note_nodes(parent_id);
CREATE INDEX idx_mind_note_nodes_order ON mind_note_nodes(mind_note_id, parent_id, order_index);

-- RLS ç­–ç•¥
ALTER TABLE mind_notes ENABLE ROW LEVEL SECURITY;
ALTER TABLE mind_note_nodes ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view their own mind notes"
  ON mind_notes FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own mind notes"
  ON mind_notes FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own mind notes"
  ON mind_notes FOR UPDATE
  USING (auth.uid() = user_id);

CREATE POLICY "Users can delete their own mind notes"
  ON mind_notes FOR DELETE
  USING (auth.uid() = user_id);

CREATE POLICY "Users can view their own mind note nodes"
  ON mind_note_nodes FOR SELECT
  USING (
    EXISTS (
      SELECT 1 FROM mind_notes 
      WHERE mind_notes.id = mind_note_nodes.mind_note_id 
      AND mind_notes.user_id = auth.uid()
    )
  );

CREATE POLICY "Users can insert their own mind note nodes"
  ON mind_note_nodes FOR INSERT
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM mind_notes 
      WHERE mind_notes.id = mind_note_nodes.mind_note_id 
      AND mind_notes.user_id = auth.uid()
    )
  );

CREATE POLICY "Users can update their own mind note nodes"
  ON mind_note_nodes FOR UPDATE
  USING (
    EXISTS (
      SELECT 1 FROM mind_notes 
      WHERE mind_notes.id = mind_note_nodes.mind_note_id 
      AND mind_notes.user_id = auth.uid()
    )
  );

CREATE POLICY "Users can delete their own mind note nodes"
  ON mind_note_nodes FOR DELETE
  USING (
    EXISTS (
      SELECT 1 FROM mind_notes 
      WHERE mind_notes.id = mind_note_nodes.mind_note_id 
      AND mind_notes.user_id = auth.uid()
    )
  );
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ app/
â”‚   â””â”€â”€ dashboard/
â”‚       â””â”€â”€ mind-notes/              # æ€ç»´ç¬”è®°æ¨¡å—
â”‚           â”œâ”€â”€ page.tsx             # æ€ç»´ç¬”è®°åˆ—è¡¨é¡µ
â”‚           â””â”€â”€ [id]/
â”‚               â””â”€â”€ page.tsx         # æ€ç»´ç¬”è®°ç¼–è¾‘é¡µ
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ MindNoteManager.tsx         # æ€ç»´ç¬”è®°åˆ—è¡¨ç®¡ç†ç»„ä»¶
â”‚   â”œâ”€â”€ MindNoteEditor.tsx          # æ€ç»´ç¬”è®°ç¼–è¾‘å™¨ç»„ä»¶
â”‚   â”œâ”€â”€ MindNode.tsx                # å•ä¸ªèŠ‚ç‚¹ç»„ä»¶
â”‚   â”œâ”€â”€ MindNodeToolbar.tsx         # èŠ‚ç‚¹å·¥å…·æ ï¼ˆç§»åŠ¨ç«¯ï¼‰
â”‚   â””â”€â”€ MindNodeRenderer.tsx        # èŠ‚ç‚¹å†…å®¹æ¸²æŸ“å™¨ï¼ˆæ”¯æŒæ ¼å¼åŒ–ï¼‰
â””â”€â”€ lib/
    â”œâ”€â”€ mind-note-utils.ts          # æ€ç»´ç¬”è®°å·¥å…·å‡½æ•°
    â””â”€â”€ mind-note-storage.ts        # æ€ç»´ç¬”è®°æ•°æ®æ“ä½œ
```

## ğŸ¨ UI/UX è®¾è®¡

### åˆ—è¡¨é¡µï¼ˆ`/dashboard/mind-notes`ï¼‰
- é¡¶éƒ¨ï¼šæ ‡é¢˜"æ€ç»´ç¬”è®°" + "æ–°å»º"æŒ‰é’®
- åˆ—è¡¨ï¼šæ˜¾ç¤ºæ‰€æœ‰æ€ç»´ç¬”è®°ï¼ˆæ ‡é¢˜ã€æ›´æ–°æ—¶é—´ã€èŠ‚ç‚¹æ•°é‡ï¼‰
- æ”¯æŒæœç´¢ã€åˆ é™¤ã€é‡å‘½å

### ç¼–è¾‘é¡µï¼ˆ`/dashboard/mind-notes/[id]`ï¼‰
- **é¡¶éƒ¨å·¥å…·æ **ï¼š
  - è¿”å›æŒ‰é’®
  - æ ‡é¢˜ç¼–è¾‘
  - ä¿å­˜çŠ¶æ€
  - æ›´å¤šèœå•ï¼ˆå¯¼å‡ºã€åˆ é™¤ç­‰ï¼‰
  
- **ç¼–è¾‘åŒºåŸŸ**ï¼š
  - æ ‘å½¢èŠ‚ç‚¹åˆ—è¡¨
  - æ¯ä¸ªèŠ‚ç‚¹å¯ç¼–è¾‘ã€å¯æ‹–æ‹½
  - æ”¯æŒæŠ˜å /å±•å¼€
  
- **ç§»åŠ¨ç«¯å·¥å…·æ **ï¼ˆåº•éƒ¨ï¼‰ï¼š
  - ç¼–è¾‘æŒ‰é’®
  - ç¼©è¿›æŒ‰é’®ï¼ˆâ†’ï¼‰
  - å‡çº§æŒ‰é’®ï¼ˆâ†ï¼‰
  - åˆ é™¤æŒ‰é’®

## ğŸ”§ æŠ€æœ¯å®ç°è¦ç‚¹

### 1. èŠ‚ç‚¹æ¸²æŸ“
- ä½¿ç”¨é€’å½’ç»„ä»¶æ¸²æŸ“æ ‘å½¢ç»“æ„
- æ”¯æŒè™šæ‹Ÿæ»šåŠ¨ï¼ˆå¦‚æœèŠ‚ç‚¹å¾ˆå¤šï¼‰
- æ‹–æ‹½æ—¶ä½¿ç”¨ `@dnd-kit` çš„ `SortableContext`

### 2. å¿«æ·é”®å¤„ç†
- ä½¿ç”¨ `useEffect` + `keydown` äº‹ä»¶ç›‘å¬
- åŒºåˆ†ç¼–è¾‘æ¨¡å¼å’Œæµè§ˆæ¨¡å¼
- é˜²æ­¢ä¸æµè§ˆå™¨é»˜è®¤å¿«æ·é”®å†²çª

### 3. æ–‡æœ¬æ ¼å¼åŒ–
- ä½¿ç”¨ç®€å•çš„æ ‡è®°è¯­æ³•ï¼š`**bold**`ã€`==highlight==`
- ç¼–è¾‘æ—¶æ˜¾ç¤ºæ ‡è®°ï¼Œé¢„è§ˆæ—¶æ¸²æŸ“æ ¼å¼åŒ–
- æˆ–ä½¿ç”¨ `contentEditable` + å¯Œæ–‡æœ¬ç¼–è¾‘

### 4. æ‹–æ‹½å®ç°
- ä½¿ç”¨ `@dnd-kit/core` + `@dnd-kit/sortable`
- æ”¯æŒè·¨å±‚çº§æ‹–æ‹½
- æ‹–æ‹½åæ›´æ–° `parent_id` å’Œ `order_index`

### 5. æ–‡æ¡£å†…åµŒ
- è§£æèŠ‚ç‚¹å†…å®¹ä¸­çš„ `[[mind_note_id|åç§°]]` è¯­æ³•
- ç‚¹å‡»æ—¶è·³è½¬åˆ°å¯¹åº”æ€ç»´ç¬”è®°æˆ–æ˜¾ç¤ºé¢„è§ˆå¼¹çª—

### 6. è‡ªåŠ¨ä¿å­˜
- ç±»ä¼¼ `NoteManager` çš„å®ç°
- ä½¿ç”¨ debounce å»¶è¿Ÿä¿å­˜
- æ˜¾ç¤ºä¿å­˜çŠ¶æ€

## ğŸ“± ç§»åŠ¨ç«¯é€‚é…

### è§¦æ‘¸äº¤äº’
- **é•¿æŒ‰æ‹–æ‹½**ï¼šä½¿ç”¨ `TouchSensor` æ£€æµ‹é•¿æŒ‰
- **ç‚¹å‡»ç¼–è¾‘**ï¼šåŒå‡»æˆ–å·¥å…·æ æŒ‰é’®
- **å·¥å…·æ **ï¼šåº•éƒ¨å›ºå®šå·¥å…·æ ï¼Œé€‰ä¸­èŠ‚ç‚¹æ—¶æ˜¾ç¤º

### å“åº”å¼å¸ƒå±€
- èŠ‚ç‚¹ç¼©è¿›åœ¨å°å±å¹•ä¸Šé€‚å½“å‡å°‘
- å·¥å…·æ æŒ‰é’®å¤§å°é€‚åˆè§¦æ‘¸
- ä½¿ç”¨ `touch-manipulation` ä¼˜åŒ–è§¦æ‘¸å“åº”

## ğŸ”„ æ•°æ®åŒæ­¥

- æ”¯æŒå®æ—¶åŒæ­¥ï¼ˆä½¿ç”¨ Supabase Realtimeï¼‰
- æ”¯æŒç¦»çº¿ç¼–è¾‘ï¼ˆä½¿ç”¨ IndexedDBï¼‰
- ç‰ˆæœ¬å†å²ï¼ˆå¯é€‰ï¼Œç±»ä¼¼ç¬”è®°çš„ç‰ˆæœ¬å†å²ï¼‰

## âœ… å¯è¡Œæ€§è¯„ä¼°

| åŠŸèƒ½ | å¯è¡Œæ€§ | æŠ€æœ¯éš¾åº¦ | å¤‡æ³¨ |
|------|--------|----------|------|
| æ— é™å±‚çº§èŠ‚ç‚¹ | âœ… é«˜ | ä½ | æ ‘å½¢æ•°æ®ç»“æ„ï¼Œé€’å½’æ¸²æŸ“ |
| æ–‡æœ¬æ ¼å¼åŒ– | âœ… é«˜ | ä¸­ | æ ‡è®°è¯­æ³•æˆ–å¯Œæ–‡æœ¬ç¼–è¾‘ |
| å¿«æ·é”® | âœ… é«˜ | ä½ | é”®ç›˜äº‹ä»¶ç›‘å¬ |
| æ‹–æ‹½é‡æ’ | âœ… é«˜ | ä¸­ | å·²æœ‰ @dnd-kit |
| æ–‡æ¡£å†…åµŒ | âœ… é«˜ | ä¸­ | ç±»ä¼¼åŒå‘é“¾æ¥å®ç° |
| ç§»åŠ¨ç«¯æ‹–æ‹½ | âœ… é«˜ | ä¸­ | TouchSensor æ”¯æŒ |
| è‡ªåŠ¨ä¿å­˜ | âœ… é«˜ | ä½ | å·²æœ‰å®ç°å‚è€ƒ |

**æ€»ä½“è¯„ä¼°ï¼šå®Œå…¨å¯è¡Œ** âœ…

é¡¹ç›®å·²æœ‰ç›¸å…³æŠ€æœ¯æ ˆï¼ˆ@dnd-kitã€Supabaseã€ç¦»çº¿å­˜å‚¨ï¼‰ï¼Œå®ç°æ€ç»´ç¬”è®°åŠŸèƒ½çš„æŠ€æœ¯åŸºç¡€å®Œå¤‡ã€‚

