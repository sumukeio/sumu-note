# 思维笔记功能 - 任务拆解

## 📌 任务列表

### Phase 1: 数据库与基础架构

#### Task 1.1: 创建数据库表结构
**优先级**: 🔴 高  
**预估时间**: 1-2 小时  
**依赖**: 无

**任务内容**:
- 在 Supabase 中执行 SQL 脚本创建 `mind_notes` 和 `mind_note_nodes` 表
- 创建索引优化查询性能
- 配置 RLS 策略确保数据安全
- 创建 SQL 文件：`docs/sql/create_mind_notes_tables.sql`

**验收标准**:
- [ ] 两个表创建成功
- [ ] 索引创建成功
- [ ] RLS 策略测试通过
- [ ] 可以正常插入和查询数据

---

#### Task 1.2: 创建数据操作工具函数
**优先级**: 🔴 高  
**预估时间**: 2-3 小时  
**依赖**: Task 1.1

**任务内容**:
- 创建 `src/lib/mind-note-storage.ts`
- 实现 CRUD 操作：
  - `createMindNote(userId, title)` - 创建思维笔记
  - `getMindNotes(userId)` - 获取用户所有思维笔记
  - `getMindNoteById(id)` - 获取单个思维笔记
  - `updateMindNote(id, data)` - 更新思维笔记
  - `deleteMindNote(id)` - 删除思维笔记
  - `createNode(mindNoteId, parentId, content, orderIndex)` - 创建节点
  - `updateNode(id, data)` - 更新节点
  - `deleteNode(id)` - 删除节点
  - `getNodesByMindNoteId(mindNoteId)` - 获取所有节点
  - `updateNodeOrder(mindNoteId, nodeId, newParentId, newOrderIndex)` - 更新节点顺序

**验收标准**:
- [ ] 所有函数实现完成
- [ ] 类型定义完整（TypeScript）
- [ ] 错误处理完善
- [ ] 可以正常操作数据库

---

#### Task 1.3: 创建工具函数库
**优先级**: 🟡 中  
**预估时间**: 1-2 小时  
**依赖**: Task 1.2

**任务内容**:
- 创建 `src/lib/mind-note-utils.ts`
- 实现工具函数：
  - `buildNodeTree(nodes)` - 将扁平节点数组构建为树形结构
  - `flattenNodeTree(tree)` - 将树形结构扁平化
  - `parseNodeContent(content)` - 解析节点内容（格式化标记）
  - `renderNodeContent(content)` - 渲染节点内容（HTML）
  - `findNodeById(tree, id)` - 在树中查找节点
  - `getNodePath(tree, id)` - 获取节点路径
  - `calculateNewOrderIndex(parentId, nodes)` - 计算新节点的排序索引

**验收标准**:
- [ ] 所有工具函数实现完成
- [ ] 单元测试通过（可选）
- [ ] 类型定义完整

---

### Phase 2: UI 组件开发

#### Task 2.1: 创建思维笔记列表页
**优先级**: 🔴 高  
**预估时间**: 2-3 小时  
**依赖**: Task 1.2

**任务内容**:
- 创建 `src/app/dashboard/mind-notes/page.tsx`
- 创建 `src/components/MindNoteManager.tsx`
- 实现功能：
  - 显示所有思维笔记列表
  - "新建思维笔记"按钮
  - 点击进入编辑页
  - 搜索功能
  - 删除功能（可选）
  - 重命名功能（可选）

**验收标准**:
- [ ] 列表页可以正常访问
- [ ] 可以创建新思维笔记
- [ ] 可以进入编辑页
- [ ] UI 符合设计规范

---

#### Task 2.2: 创建节点组件（基础版）
**优先级**: 🔴 高  
**预估时间**: 3-4 小时  
**依赖**: Task 1.3

**任务内容**:
- 创建 `src/components/MindNode.tsx`
- 实现功能：
  - 显示节点内容（纯文本）
  - 支持编辑模式
  - 显示子节点（递归渲染）
  - 基本的展开/折叠功能
  - 节点缩进显示

**验收标准**:
- [ ] 节点可以正常显示
- [ ] 可以编辑节点内容
- [ ] 树形结构正确渲染
- [ ] 展开/折叠功能正常

---

#### Task 2.3: 创建思维笔记编辑器主组件
**优先级**: 🔴 高  
**预估时间**: 3-4 小时  
**依赖**: Task 2.2

**任务内容**:
- 创建 `src/app/dashboard/mind-notes/[id]/page.tsx`
- 创建 `src/components/MindNoteEditor.tsx`
- 实现功能：
  - 加载思维笔记数据
  - 渲染根节点和所有子节点
  - 标题编辑
  - 自动保存功能
  - 返回按钮

**验收标准**:
- [ ] 可以打开思维笔记
- [ ] 节点树正确显示
- [ ] 标题可以编辑
- [ ] 自动保存功能正常

---

### Phase 3: 核心功能实现

#### Task 3.1: 实现快捷键系统（电脑端）
**优先级**: 🔴 高  
**预估时间**: 3-4 小时  
**依赖**: Task 2.3

**任务内容**:
- 在 `MindNoteEditor` 中实现快捷键：
  - **Tab**: 创建子节点
  - **Enter**: 创建同级节点
  - **Shift + Tab**: 提升层级
  - **Alt + .**: 全部展开/折叠
  - **Ctrl/Cmd + B**: 加粗（如果使用富文本）
- 处理焦点管理
- 防止与浏览器默认快捷键冲突

**验收标准**:
- [ ] 所有快捷键正常工作
- [ ] 焦点管理正确
- [ ] 不会触发浏览器默认行为
- [ ] 快捷键提示（可选）

---

#### Task 3.2: 实现节点拖拽功能
**优先级**: 🔴 高  
**预估时间**: 4-5 小时  
**依赖**: Task 2.2

**任务内容**:
- 集成 `@dnd-kit/core` 和 `@dnd-kit/sortable`
- 实现拖拽：
  - 拖拽节点改变顺序
  - 拖拽节点改变层级（拖到其他节点下）
  - 拖拽视觉反馈
  - 拖拽后更新数据库
- 处理拖拽边界情况（不能拖到自己子节点下等）

**验收标准**:
- [ ] 可以拖拽节点
- [ ] 拖拽改变顺序正常
- [ ] 拖拽改变层级正常
- [ ] 拖拽后数据正确保存
- [ ] 拖拽体验流畅

---

#### Task 3.3: 实现文本格式化功能
**优先级**: 🟡 中  
**预估时间**: 3-4 小时  
**依赖**: Task 2.2

**任务内容**:
- 创建 `src/components/MindNodeRenderer.tsx`
- 实现格式化解析：
  - `**文本**` → 加粗
  - `==文本==` → 高亮
- 编辑时显示标记，预览时渲染格式化
- 或使用 `contentEditable` + 富文本编辑（更复杂但体验更好）

**验收标准**:
- [ ] 加粗功能正常
- [ ] 高亮功能正常
- [ ] 编辑和预览模式切换正常
- [ ] 格式化标记正确解析

---

### Phase 4: 移动端适配

#### Task 4.1: 创建移动端工具栏
**优先级**: 🟡 中  
**预估时间**: 2-3 小时  
**依赖**: Task 2.2

**任务内容**:
- 创建 `src/components/MindNodeToolbar.tsx`
- 实现功能：
  - 选中节点时底部显示工具栏
  - 编辑按钮
  - 缩进按钮（→）
  - 升级按钮（←）
  - 删除按钮
- 工具栏动画和样式

**验收标准**:
- [ ] 工具栏在移动端正常显示
- [ ] 所有按钮功能正常
- [ ] 工具栏样式美观
- [ ] 动画流畅

---

#### Task 4.2: 实现移动端拖拽
**优先级**: 🟡 中  
**预估时间**: 3-4 小时  
**依赖**: Task 3.2

**任务内容**:
- 使用 `@dnd-kit` 的 `TouchSensor`
- 实现长按拖拽：
  - 长按节点触发拖拽
  - 拖到节点上方 → 变子节点
  - 拖到节点旁边 → 变同级
- 优化触摸体验（防止误触）

**验收标准**:
- [ ] 长按可以拖拽
- [ ] 拖拽到不同位置正确改变层级
- [ ] 触摸体验流畅
- [ ] 不会误触

---

#### Task 4.3: 移动端键盘处理
**优先级**: 🟡 中  
**预估时间**: 2-3 小时  
**依赖**: Task 3.1

**任务内容**:
- 处理移动端键盘事件：
  - Enter 键创建同级节点
  - 工具栏提供缩进/升级按钮
- 优化移动端输入体验

**验收标准**:
- [ ] Enter 键功能正常
- [ ] 工具栏按钮功能正常
- [ ] 输入体验流畅

---

### Phase 5: 高级功能

#### Task 5.1: 实现文档内嵌功能
**优先级**: 🟢 低  
**预估时间**: 3-4 小时  
**依赖**: Task 3.3

**任务内容**:
- 在节点内容解析中识别 `[[mind_note_id|名称]]` 语法
- 渲染为可点击链接
- 点击时跳转到对应思维笔记或显示预览
- 实现预览弹窗（可选）

**验收标准**:
- [ ] 内嵌语法正确解析
- [ ] 链接可以点击
- [ ] 跳转功能正常
- [ ] 预览功能正常（如果实现）

---

#### Task 5.2: 实现全部展开/折叠功能
**优先级**: 🟢 低  
**预估时间**: 1-2 小时  
**依赖**: Task 2.2

**任务内容**:
- 实现 `Alt + .` 快捷键
- 切换所有节点的展开/折叠状态
- 保存展开状态到数据库（可选）

**验收标准**:
- [ ] 快捷键正常工作
- [ ] 所有节点正确展开/折叠
- [ ] 状态可以保存（如果实现）

---

#### Task 5.3: 实现实时同步（可选）
**优先级**: 🟢 低  
**预估时间**: 3-4 小时  
**依赖**: Task 2.3

**任务内容**:
- 使用 Supabase Realtime 监听思维笔记变化
- 多端同时编辑时提示冲突
- 参考 `NoteManager` 的实现

**验收标准**:
- [ ] 实时同步功能正常
- [ ] 冲突处理正确
- [ ] 体验流畅

---

#### Task 5.4: 实现离线支持（可选）
**优先级**: 🟢 低  
**预估时间**: 3-4 小时  
**依赖**: Task 2.3

**任务内容**:
- 使用 IndexedDB 存储离线数据
- 网络恢复时自动同步
- 参考 `NoteManager` 的实现

**验收标准**:
- [ ] 离线编辑功能正常
- [ ] 自动同步功能正常
- [ ] 状态指示清晰

---

## 📊 任务优先级总结

### 🔴 高优先级（核心功能）
1. Task 1.1: 创建数据库表结构
2. Task 1.2: 创建数据操作工具函数
3. Task 1.3: 创建工具函数库
4. Task 2.1: 创建思维笔记列表页
5. Task 2.2: 创建节点组件（基础版）
6. Task 2.3: 创建思维笔记编辑器主组件
7. Task 3.1: 实现快捷键系统（电脑端）
8. Task 3.2: 实现节点拖拽功能

### 🟡 中优先级（重要功能）
9. Task 3.3: 实现文本格式化功能
10. Task 4.1: 创建移动端工具栏
11. Task 4.2: 实现移动端拖拽
12. Task 4.3: 移动端键盘处理

### 🟢 低优先级（增强功能）
13. Task 5.1: 实现文档内嵌功能
14. Task 5.2: 实现全部展开/折叠功能
15. Task 5.3: 实现实时同步（可选）
16. Task 5.4: 实现离线支持（可选）

---

## 🎯 建议开发顺序

### MVP（最小可行产品）
完成以下任务即可发布基础版本：
1. Task 1.1 → Task 1.2 → Task 1.3（数据库和工具函数）
2. Task 2.1 → Task 2.2 → Task 2.3（基础 UI）
3. Task 3.1 → Task 3.2（核心功能）

### V1.0（完整功能）
在 MVP 基础上增加：
4. Task 3.3（文本格式化）
5. Task 4.1 → Task 4.2 → Task 4.3（移动端适配）

### V1.1（增强功能）
在 V1.0 基础上增加：
6. Task 5.1 → Task 5.2（高级功能）
7. Task 5.3 → Task 5.4（可选功能）

---

## 📝 注意事项

1. **数据迁移**：如果后续需要修改表结构，需要编写迁移脚本
2. **性能优化**：如果节点数量很多（>1000），考虑虚拟滚动
3. **用户体验**：拖拽和快捷键需要充分测试，确保流畅
4. **移动端适配**：需要在实际设备上测试，模拟器可能不准确
5. **错误处理**：所有数据库操作都需要完善的错误处理
6. **类型安全**：使用 TypeScript 确保类型安全

---

## 🔍 测试清单

每个任务完成后需要测试：
- [ ] 功能正常工作
- [ ] 错误处理正确
- [ ] 类型检查通过
- [ ] 移动端适配正常（如果涉及）
- [ ] 性能可接受

