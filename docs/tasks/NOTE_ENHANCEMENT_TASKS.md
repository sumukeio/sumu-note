# 笔记功能增强与Bug修复 - 任务拆解

> 基于需求文档：`docs/requirements/需求分析_滑动误触与笔记功能增强.md`
> 任务按优先级和依赖关系排序

---

## 📋 Phase 0: Bug修复（P0 - 必须）

### Task 0.1: 修复滑动误触问题
**优先级**: 🔴 P0（必须）  
**预估时间**: 2-3 小时  
**依赖**: 无  
**状态**: ✅ 已完成

**任务内容**:
- 修改 `src/components/MindNoteManager.tsx`
- 在 `handleTouchStart` 中记录初始触摸位置（`touchstart` 事件的坐标）
- 添加 `handleTouchMove` 处理函数，检测滑动距离
- 计算触摸移动距离：`Math.sqrt((x2-x1)^2 + (y2-y1)^2)`
- 如果移动距离超过阈值（10-15px），清除长按定时器
- 在 `DraggableFolderCard` 和 `DraggableMindNoteCard` 组件上添加 `onTouchMove` 事件处理
- 确保滑动操作不会触发选择模式

**技术实现要点**:
- 使用 `useRef` 存储初始触摸位置和定时器引用
- 在 `touchmove` 事件中实时检测滑动距离
- 如果检测到滑动，立即调用 `clearTimeout` 清除长按定时器
- 确保长按功能仍然正常工作（500ms延迟）

**验收标准**:
- [ ] 在移动端滑动页面时，不会误触发笔记选中
- [ ] 长按功能仍然正常工作（500ms延迟）
- [ ] PC端点击和拖拽功能不受影响
- [ ] 移动端滑动体验流畅，无误触

**相关文件**:
- `src/components/MindNoteManager.tsx`
- `src/components/DraggableFolderCard.tsx`（如果存在）
- `src/components/DraggableMindNoteCard.tsx`（如果存在）

---

### Task 0.2: 修复任务详情拖拽冲突
**优先级**: 🔴 P0（必须）  
**预估时间**: 0.5 小时  
**依赖**: 无  
**状态**: ✅ 已完成

**任务内容**:
- 修改 `src/components/TodoDetail.tsx`
- 在弹窗最外层容器上添加事件处理器，阻止拖拽事件传播
- 阻止 `mousedown`、`touchstart`、`dragstart` 事件冒泡到父级

**技术实现要点**:
- 在 `TodoDetail` 的最外层容器（遮罩层和内容容器）上添加事件处理器
- 使用 `e.stopPropagation()` 阻止事件冒泡到父级的 `DndContext`
- 确保弹窗内部的正常交互不受影响

**验收标准**:
- [x] 在任务详情页面选中文字时，不会触发任务拖动
- [x] 任务详情弹窗内部的交互正常（输入、选择等）
- [x] 任务列表的拖拽功能仍然正常工作

**相关文件**:
- `src/components/TodoDetail.tsx`

---

## 📋 Phase 1: 笔记统计信息（P1 - 高优先级）

### Task 1.1: 创建笔记统计信息组件
**优先级**: 🟢 P1（高优先级）  
**预估时间**: 1-2 小时  
**依赖**: 无  
**状态**: ✅ 已完成

**任务内容**:
- 创建 `src/components/NoteStats.tsx` 组件
- 实现字数统计功能：
  - 统计 `content` 的字符数（中文字符按1个计算）
  - 使用 `useMemo` 优化计算，避免频繁重新计算
  - 实时更新（在 `content` 变化时重新计算）
- 实现时间显示功能：
  - 格式化 `created_at` 和 `updated_at`
  - 使用友好的时间格式（如"2024年1月20日 14:30"）
  - 支持相对时间显示（可选，如"2小时前"）
- UI设计：
  - 固定在编辑器底部
  - 使用较小的字体和 muted 颜色
  - 响应式设计，移动端适配

**技术实现要点**:
- 使用 `useMemo` 计算字数：`content.length`
- 创建日期格式化函数或使用 `date-fns` 库
- 组件接收 `content`、`created_at`、`updated_at` 作为 props

**验收标准**:
- [ ] 显示字数统计（实时更新）
- [ ] 显示创建时间（友好格式）
- [ ] 显示最后编辑时间（友好格式）
- [ ] 在编辑器底部固定显示
- [ ] 移动端布局正常

**相关文件**:
- `src/components/NoteStats.tsx`（新建）
- `src/components/NoteManager.tsx`（集成）

---

### Task 1.2: 集成统计信息到笔记编辑器
**优先级**: 🟢 P1（高优先级）  
**预估时间**: 0.5-1 小时  
**依赖**: Task 1.1  
**状态**: ✅ 已完成

**任务内容**:
- 修改 `src/components/NoteManager.tsx`
- 在编辑器底部集成 `NoteStats` 组件
- 传递必要的 props：`content`、`created_at`、`updated_at`
- 确保统计信息在编辑模式和预览模式下都显示
- 调整编辑器布局，为统计信息预留空间

**技术实现要点**:
- 在编辑器容器底部添加 `NoteStats` 组件
- 确保统计信息不遮挡编辑器内容
- 使用 `sticky` 或 `fixed` 定位（可选）

**验收标准**:
- [ ] 统计信息正确显示在编辑器底部
- [ ] 统计信息实时更新
- [ ] 不影响编辑器正常使用
- [ ] 移动端显示正常

**相关文件**:
- `src/components/NoteManager.tsx`

---

## 📋 Phase 2: 笔记查找与替换（P2 - 中优先级）

### Task 2.1: 创建查找替换工具函数
**优先级**: 🟡 P2（中优先级）  
**预估时间**: 2-3 小时  
**依赖**: 无  
**状态**: ✅ 已完成

**任务内容**:
- 创建 `src/lib/search-utils.ts`
- 实现查找相关工具函数：
  - `findAllMatches(text, query, caseSensitive?)` - 查找所有匹配项，返回位置数组
  - `getMatchIndex(matches, cursorPosition)` - 根据光标位置获取当前匹配项索引
  - `getNextMatchIndex(currentIndex, matches)` - 获取下一个匹配项索引
  - `getPreviousMatchIndex(currentIndex, matches)` - 获取上一个匹配项索引
  - `highlightMatches(text, query, caseSensitive?)` - 高亮匹配项（返回带标记的文本）
- 实现替换相关工具函数：
  - `replaceMatch(text, query, replacement, matchIndex)` - 替换单个匹配项
  - `replaceAllMatches(text, query, replacement, caseSensitive?)` - 替换所有匹配项

**技术实现要点**:
- 使用正则表达式进行文本匹配
- 支持大小写敏感选项
- 处理特殊字符转义
- 返回匹配项的位置信息（start, end）

**验收标准**:
- [ ] 所有工具函数实现完成
- [ ] 类型定义完整（TypeScript）
- [ ] 支持大小写敏感选项
- [ ] 正确处理特殊字符
- [ ] 单元测试通过（可选）

**相关文件**:
- `src/lib/search-utils.ts`（新建）

---

### Task 2.2: 创建查找替换对话框组件
**优先级**: 🟡 P2（中优先级）  
**预估时间**: 3-4 小时  
**依赖**: Task 2.1  
**状态**: ✅ 已完成

**任务内容**:
- 创建 `src/components/FindReplaceDialog.tsx` 组件
- 实现查找功能：
  - 查找输入框
  - 实时高亮匹配项
  - 显示匹配项数量（如 "1/5"）
  - "上一个"/"下一个"按钮
  - 支持大小写敏感选项（可选）
- 实现替换功能：
  - 替换输入框
  - "替换"按钮（单个）
  - "全部替换"按钮
  - 替换后自动定位到下一个匹配项
- UI设计：
  - 固定在编辑器顶部或底部
  - 支持关闭按钮（`Esc` 键）
  - 移动端适配

**技术实现要点**:
- 使用 `Dialog` 或 `Popover` 组件（或自定义固定面板）
- 监听键盘事件（`Enter`、`Shift+Enter`、`Esc`）
- 使用 `Textarea` 的 `selectionStart` 和 `selectionEnd` 来定位文本
- 实现文本高亮（可以使用 `mark` 标签或自定义样式）

**验收标准**:
- [ ] 查找输入框正常工作
- [ ] 实时高亮所有匹配项
- [ ] 显示匹配项数量
- [ ] 支持上下切换匹配项
- [ ] 支持单个替换和全部替换
- [ ] 支持 `Esc` 键关闭
- [ ] 移动端显示正常

**相关文件**:
- `src/components/FindReplaceDialog.tsx`（新建）
- `src/components/ui/dialog.tsx`（如果使用）

---

### Task 2.3: 集成查找替换到笔记编辑器
**优先级**: 🟡 P2（中优先级）  
**预估时间**: 2-3 小时  
**依赖**: Task 2.2  
**状态**: ✅ 已完成

**任务内容**:
- 修改 `src/components/NoteManager.tsx`
- 添加查找替换状态管理：
  - `isFindReplaceOpen` - 控制查找替换面板显示/隐藏
  - `findQuery` - 查找关键词
  - `replaceQuery` - 替换文本
  - `currentMatchIndex` - 当前匹配项索引
  - `matches` - 所有匹配项数组
- 实现快捷键：
  - `Ctrl+F`（PC）打开查找面板
  - `Ctrl+H`（PC）打开替换面板
  - `Esc` 关闭面板
- 集成 `FindReplaceDialog` 组件
- 实现查找替换逻辑：
  - 调用 `search-utils` 中的工具函数
  - 更新编辑器内容（替换时）
  - 定位到匹配项位置
  - 高亮显示匹配项

**技术实现要点**:
- 使用 `useEffect` 监听键盘快捷键
- 在编辑模式下显示查找替换面板
- 替换时更新 `content` 状态
- 使用 `textareaRef.current.setSelectionRange()` 定位光标

**验收标准**:
- [ ] 支持 `Ctrl+F` 快捷键打开查找面板
- [ ] 支持 `Ctrl+H` 快捷键打开替换面板
- [ ] 查找替换功能正常工作
- [ ] 替换后内容正确更新
- [ ] 移动端通过工具栏按钮触发（可选）

**相关文件**:
- `src/components/NoteManager.tsx`

---

## 📋 Phase 3: 全局查找增强（P3 - 中优先级）

### Task 3.1: 增强搜索结果列表导航
**优先级**: 🟡 P3（中优先级）  
**预估时间**: 2-3 小时  
**依赖**: Task 2.1（复用查找工具函数）  
**状态**: ✅ 已完成

**任务内容**:
- 修改 `src/app/dashboard/page.tsx`
- 在搜索结果列表中添加键盘导航：
  - 上下箭头键切换选中结果
  - `Enter` 键打开选中的结果
- 实现结果高亮：
  - 当前选中的结果高亮显示
  - 鼠标悬停时高亮
- 添加状态管理：
  - `selectedResultIndex` - 当前选中的结果索引
  - 监听键盘事件（上下箭头键）

**技术实现要点**:
- 使用 `useState` 管理选中索引
- 使用 `useEffect` 监听键盘事件
- 使用 `scrollIntoView` 确保选中结果可见
- 高亮显示当前选中的结果

**验收标准**:
- [ ] 在搜索结果中可以使用上下箭头键切换
- [ ] 当前选中的结果高亮显示
- [ ] `Enter` 键可以打开选中的结果
- [ ] 鼠标点击可以切换选中结果

**相关文件**:
- `src/app/dashboard/page.tsx`

---

### Task 3.2: 实现笔记详情页内结果切换
**优先级**: 🟡 P3（中优先级）  
**预估时间**: 3-4 小时  
**依赖**: Task 2.1（复用查找工具函数）  
**状态**: ✅ 已完成

**任务内容**:
- 修改 `src/app/notes/[id]/page.tsx`
- 解析所有匹配项的位置（使用 `search-utils`）
- 实现"下一个"/"上一个"按钮：
  - 显示当前匹配项位置（如 "2/5"）
  - 支持快捷键（如 `Ctrl+G` / `F3`）
- 实现匹配项切换逻辑：
  - 记录当前匹配项索引
  - 切换时滚动到对应位置
  - 高亮显示当前匹配项
- UI设计：
  - 浮动按钮或工具栏
  - 显示匹配项位置信息

**技术实现要点**:
- 使用 `search` query参数获取搜索关键词（已实现）
- 使用 `TreeWalker` 或 `querySelectorAll` 查找所有文本节点
- 使用 `scrollIntoView` 滚动到匹配项位置
- 高亮显示当前匹配项（使用 `mark` 标签）

**验收标准**:
- [ ] 在笔记详情页中，如果通过搜索进入，可以切换页面内的匹配项
- [ ] 显示当前匹配项位置（如 "2/5"）
- [ ] 切换时自动滚动到匹配项位置并高亮
- [ ] 支持快捷键切换（可选）

**相关文件**:
- `src/app/notes/[id]/page.tsx`

---

## 📋 Phase 4: 表格支持（P4 - 低优先级）

### Task 4.1: 实现基础表格插入功能
**优先级**: 🔵 P4（低优先级）  
**预估时间**: 2-3 小时  
**依赖**: 无  
**状态**: ✅ 已完成

**任务内容**:
- 修改 `src/components/NoteManager.tsx`
- 添加"插入表格"工具栏按钮
- 实现表格插入功能：
  - 插入标准 Markdown 表格语法（2x2）
  - 光标定位到第一个单元格
  - 表格模板：
    ```
    |  |  |
    |--|--|
    |  |  |
    ```
- 使用 `Textarea` 的 `setSelectionRange` 定位光标

**技术实现要点**:
- 获取当前光标位置
- 插入表格 Markdown 语法
- 计算插入后光标应该定位的位置（第一个单元格）
- 更新 `content` 状态

**验收标准**:
- [ ] 支持插入2x2表格（Markdown格式）
- [ ] 插入后光标定位到第一个单元格
- [ ] 表格在预览模式下正确渲染
- [ ] 工具栏按钮正常显示

**相关文件**:
- `src/components/NoteManager.tsx`

---

### Task 4.2: 实现表格编辑辅助工具（可选）
**优先级**: 🔵 P4（低优先级）  
**预估时间**: 3-4 小时  
**依赖**: Task 4.1  
**状态**: ✅ 已完成

**任务内容**:
- 创建表格编辑辅助工具：
  - 快速添加行（在表格末尾添加一行）
  - 快速添加列（在表格末尾添加一列）
  - 表格格式化（对齐表格列）
- 实现表格解析功能：
  - 解析 Markdown 表格语法
  - 检测当前光标是否在表格内
  - 获取表格的行数和列数

**技术实现要点**:
- 使用正则表达式解析 Markdown 表格
- 检测光标位置是否在表格内
- 插入新行/列时保持表格格式

**验收标准**:
- [ ] 可以快速添加表格行
- [ ] 可以快速添加表格列
- [ ] 表格格式化功能正常
- [ ] 检测光标位置功能正常

**相关文件**:
- `src/lib/table-utils.ts`（新建，可选）
- `src/components/NoteManager.tsx`

---

### Task 4.3: 实现可视化表格编辑器（可选，高级功能）
**优先级**: 🔵 P4（低优先级）  
**预估时间**: 8-10 小时  
**依赖**: Task 4.1, Task 4.2  
**状态**: ✅ 已完成

**任务内容**:
- 创建 `src/components/TableEditor.tsx` 组件
- 实现可视化表格编辑：
  - 在编辑模式下，表格显示为可编辑的HTML表格
  - 支持添加/删除行/列
  - 支持单元格编辑
  - 编辑完成后，将HTML表格转换回Markdown格式
- 实现表格与Markdown的双向转换：
  - Markdown → HTML表格
  - HTML表格 → Markdown

**技术实现要点**:
- 使用 `contentEditable` 或自定义表格组件
- 实现表格与Markdown的双向转换
- 检测表格边界，支持添加/删除行/列

**验收标准**:
- [ ] 表格在编辑模式下显示为可编辑的HTML表格
- [ ] 支持添加/删除行/列
- [ ] 支持单元格编辑
- [ ] 表格与Markdown转换正确

**相关文件**:
- `src/components/TableEditor.tsx`（新建，可选）
- `src/lib/table-utils.ts`

---

## 📋 Phase 5: 笔记导出功能（P2 - 中优先级）

### Task 5.1: 实现笔记导出功能
**优先级**: 🟡 P2（中优先级）  
**预估时间**: 4-6 小时  
**依赖**: 无  
**状态**: ✅ 已完成

**任务内容**:
- 创建 `src/components/ExportDialog.tsx` 组件
- 创建 `src/components/ui/checkbox.tsx` 组件（支持 indeterminate 状态）
- 在 `NoteManager` 中添加导出按钮
- 实现导出选择对话框：
  - 显示所有文件夹和笔记（树形结构）
  - 默认展开所有文件夹
  - 支持文件夹展开/折叠
  - 全选功能
  - 文件夹选择（支持全选/半选/未选状态）
  - 单个笔记选择
- 实现导出逻辑：
  - 使用 `jszip` 创建 ZIP 压缩包
  - 按文件夹组织笔记
  - 未分类笔记放在根目录
  - 文件命名处理特殊字符

**技术实现要点**:
- 使用 `Dialog` 组件创建导出对话框
- 使用 `Checkbox` 组件实现选择功能
- 使用 `Set` 管理选中状态
- 使用 `jszip` 和 `file-saver` 实现导出

**验收标准**:
- [x] 导出对话框正确显示
- [x] 文件夹和笔记列表正确展示
- [x] 全选功能正常工作
- [x] 文件夹选择功能正常（全选/半选/未选）
- [x] 单个笔记选择功能正常
- [x] 导出为 ZIP 压缩包成功
- [x] 压缩包内文件结构正确
- [x] 移动端和桌面端都正常

**相关文件**:
- `src/components/ExportDialog.tsx`（新建）
- `src/components/ui/checkbox.tsx`（新建）
- `src/components/NoteManager.tsx`（修改）

---

## 📊 任务总览

### 任务统计
- **总任务数**: 13
- **已完成**: 13（全部任务已完成）
- **待开始**: 0
- **可选任务**: 2（Task 4.2, Task 4.3）

### 优先级分布
- **P0（必须）**: 2 个任务
- **P1（高优先级）**: 2 个任务
- **P2（中优先级）**: 4 个任务（包含 Task 5.1）
- **P3（中优先级）**: 2 个任务
- **P4（低优先级）**: 3 个任务

### 预估总时间
- **必须任务（P0-P2）**: 约 15-20 小时
- **可选任务（P3-P4）**: 约 13-17 小时
- **总计**: 约 28-37 小时

### 依赖关系图
```
Task 0.1 (滑动误触修复)
  └─ 无依赖

Task 0.2 (拖拽冲突修复)
  └─ ✅ 已完成

Task 1.1 (统计信息组件)
  └─ 无依赖

Task 1.2 (集成统计信息)
  └─ Task 1.1

Task 2.1 (查找替换工具函数)
  └─ 无依赖

Task 2.2 (查找替换对话框)
  └─ Task 2.1

Task 2.3 (集成查找替换)
  └─ Task 2.2

Task 3.1 (搜索结果导航)
  └─ Task 2.1 (复用工具函数)

Task 3.2 (详情页结果切换)
  └─ Task 2.1 (复用工具函数)

Task 4.1 (基础表格插入)
  └─ 无依赖

Task 4.2 (表格编辑辅助)
  └─ Task 4.1 (可选)

Task 4.3 (可视化表格编辑器)
  └─ Task 4.1, Task 4.2 (可选)

Task 5.1 (笔记导出功能)
  └─ 无依赖
```

---

## 🚀 执行建议

### 第一阶段：Bug修复（必须）
1. Task 0.1 - 修复滑动误触问题
2. Task 0.2 - ✅ 已完成

### 第二阶段：快速提升（高优先级）
3. Task 1.1 - 创建统计信息组件
4. Task 1.2 - 集成统计信息

### 第三阶段：核心功能（中优先级）
5. Task 2.1 - 创建查找替换工具函数
6. Task 2.2 - 创建查找替换对话框
7. Task 2.3 - 集成查找替换

### 第四阶段：增强功能（中优先级）
8. Task 3.1 - 增强搜索结果导航
9. Task 3.2 - 实现详情页结果切换

### 第五阶段：扩展功能（低优先级，可选）
10. Task 4.1 - 实现基础表格插入
11. Task 4.2 - 实现表格编辑辅助（可选）
12. Task 4.3 - 实现可视化表格编辑器（可选，后续迭代）

### 第六阶段：导出功能（中优先级）
13. Task 5.1 - 实现笔记导出功能

---

## 📝 注意事项

1. **代码复用**：Task 2.1 创建的查找工具函数可以被 Task 3.1 和 Task 3.2 复用
2. **移动端适配**：所有UI组件都需要考虑移动端适配
3. **性能优化**：使用 `useMemo` 和 `useCallback` 优化性能
4. **类型安全**：确保所有代码都有完整的 TypeScript 类型定义
5. **测试**：建议为关键功能编写单元测试

---

## ✅ 完成标准

每个任务完成后，需要：
1. 代码审查通过
2. 功能测试通过（包括移动端）
3. 更新任务状态为 ✅ 已完成
4. 更新相关文档（如有需要）
