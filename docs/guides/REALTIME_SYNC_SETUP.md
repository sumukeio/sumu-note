# 实时同步功能设置指南

## 功能说明

SumuNote 现已支持**实时同步**功能，参考飞书云文档的实现方式：

- ✅ 使用 Supabase Realtime 监听笔记变化
- ✅ 多端同时编辑时自动检测云端更新
- ✅ 智能提示用户选择：刷新查看最新内容 或 保留本地更改
- ✅ 无需手动刷新页面即可看到其他设备的更新

## 设置步骤

### 1. 在 Supabase 控制台启用 Realtime

1. 登录 [Supabase Dashboard](https://app.supabase.com)
2. 选择你的项目
3. 进入 **Database** → **Replication** 页面
4. 找到 `notes` 表，点击右侧的开关启用 Realtime

或者使用 SQL：

```sql
-- 启用 notes 表的 Realtime
ALTER PUBLICATION supabase_realtime ADD TABLE notes;
```

### 2. 验证设置

运行以下 SQL 查询验证 Realtime 已启用：

```sql
SELECT * FROM pg_publication_tables WHERE pubname = 'supabase_realtime' AND tablename = 'notes';
```

如果返回一行数据，说明设置成功。

### 3. 测试实时同步

1. 在电脑端打开一个笔记进行编辑
2. 在手机端（或其他浏览器标签页）打开同一篇笔记
3. 在电脑端保存笔记
4. 手机端应该会收到提示："云端有更新"
5. 选择"刷新查看最新"即可看到最新内容

## 工作原理

1. **打开编辑器时**：自动订阅当前笔记的 Realtime 事件
2. **保存笔记时**：记录保存时间戳
3. **检测到云端更新**：比较时间戳，如果不是自己保存的，显示提示对话框
4. **用户选择**：
   - **刷新查看最新**：放弃本地更改，加载云端最新内容
   - **保留我的更改**：使用本地内容覆盖云端

## 注意事项

- ⚠️ Realtime 订阅仅在编辑器打开时生效
- ⚠️ 如果用户选择"保留我的更改"，会覆盖其他设备的更改
- ⚠️ 时间戳比较基于 `updated_at` 字段，确保数据库时区设置正确

## 故障排除

### 问题：没有收到更新提示

**可能原因：**
1. Realtime 未启用：检查 Supabase Dashboard → Database → Replication
2. 网络连接问题：检查浏览器控制台是否有 WebSocket 连接错误
3. 权限问题：确保用户有读取 `notes` 表的权限

**解决方法：**
- 检查浏览器控制台（F12）的 Network 标签，查看 WebSocket 连接状态
- 确认 Supabase RLS (Row Level Security) 策略允许用户读取自己的笔记

### 问题：提示过于频繁

如果觉得提示过于频繁，可以：
- 在提示对话框中短暂延迟显示（当前实现是立即显示）
- 添加"忽略此更新"选项

## 未来优化方向

参考飞书云文档，未来可以考虑：

1. **操作转换（OT）算法**：实现真正的协同编辑，无需手动选择
2. **冲突自动合并**：智能合并不同设备的更改
3. **版本历史**：保留编辑历史，支持查看和恢复
4. **离线支持**：在离线状态下缓存更改，恢复网络后自动同步

