# 任务管理功能 - 任务拆解

> 基于需求文档，实现完整的任务管理功能
> 任务按优先级和依赖关系排序

---

## 📋 Phase 1: 数据库与基础架构

### Task 1.1: 创建数据库表结构
**优先级**: 🔴 高  
**预估时间**: 2-3 小时  
**依赖**: 无

**任务内容**:
- 在 Supabase 中执行 SQL 脚本创建 `todos` 和 `todo_lists` 表
- 创建索引优化查询性能
- 配置 RLS 策略确保数据安全
- 创建 SQL 文件：`docs/sql/create_todos_tables.sql`

**验收标准**:
- [x] 两个表创建成功
- [x] 索引创建成功
- [x] RLS 策略测试通过
- [x] 可以正常插入和查询数据
- [x] 外键约束正确

---

### Task 1.2: 创建数据操作工具函数
**优先级**: 🔴 高  
**预估时间**: 3-4 小时  
**依赖**: Task 1.1

**任务内容**:
- 创建 `src/lib/todo-storage.ts`
- 实现任务 CRUD 操作：
  - `createTodo(userId, data)` - 创建任务
  - `getTodos(userId, filters)` - 获取任务列表（支持筛选、排序、分页）
  - `getTodoById(id)` - 获取单个任务
  - `updateTodo(id, data)` - 更新任务
  - `deleteTodo(id)` - 删除任务（软删除）
  - `completeTodo(id)` - 完成任务
  - `uncompleteTodo(id)` - 取消完成
  - `moveTodo(id, listId)` - 移动任务到清单
  - `reorderTodos(todoIds)` - 批量更新排序
- 实现清单 CRUD 操作：
  - `createTodoList(userId, data)` - 创建清单
  - `getTodoLists(userId)` - 获取清单列表
  - `getTodoListById(id)` - 获取单个清单
  - `updateTodoList(id, data)` - 更新清单
  - `deleteTodoList(id)` - 删除清单
- 实现子任务操作：
  - `getSubtodos(parentId)` - 获取子任务列表
  - `createSubtodo(parentId, data)` - 创建子任务

**验收标准**:
- [x] 所有函数实现完成
- [x] 类型定义完整（TypeScript）
- [x] 错误处理完善
- [x] 可以正常操作数据库
- [x] 支持筛选、排序、分页

---

### Task 1.3: 创建工具函数库
**优先级**: 🟡 中  
**预估时间**: 2-3 小时  
**依赖**: Task 1.2

**任务内容**:
- 创建 `src/lib/todo-utils.ts`
- 实现工具函数：
  - `parseTaskInput(input)` - 解析任务输入，识别日期/时间/标签/优先级
  - `formatDueDate(date)` - 格式化截止日期显示
  - `getPriorityColor(priority)` - 获取优先级颜色
  - `getStatusColor(status)` - 获取状态颜色
  - `calculateCompletionRate(todos)` - 计算完成率
  - `groupTodosByDate(todos)` - 按日期分组任务
  - `filterTodos(todos, filters)` - 筛选任务
  - `sortTodos(todos, sortBy)` - 排序任务
  - `buildTodoTree(todos)` - 构建任务树（父子关系）

**验收标准**:
- [x] 所有工具函数实现完成
- [x] 单元测试通过（可选）
- [x] 类型定义完整
- [x] 智能识别功能正常

---

## 📋 Phase 2: UI 组件开发

### Task 2.1: 创建任务管理主页面
**优先级**: 🔴 高  
**预估时间**: 3-4 小时  
**依赖**: Task 1.2

**任务内容**:
- 创建 `src/app/dashboard/todos/page.tsx`
- 创建 `src/components/TodoManager.tsx`
- 实现功能：
  - 页面布局（侧边栏 + 主内容区）
  - 清单列表显示
  - 视图切换（列表/日历/看板/四象限）
  - 快速添加任务输入框
  - 返回按钮

**验收标准**:
- [x] 页面可以正常访问
- [x] 布局符合设计规范
- [x] 响应式设计正常
- [x] 视图切换功能正常

---

### Task 2.2: 创建任务列表组件
**优先级**: 🔴 高  
**预估时间**: 3-4 小时  
**依赖**: Task 2.1

**任务内容**:
- 创建 `src/components/TodoList.tsx`
- 创建 `src/components/TodoItem.tsx`
- 实现功能：
  - 显示任务列表
  - 任务卡片显示（标题、日期、优先级、标签）
  - 任务完成/取消完成
  - 任务点击展开详情
  - 任务拖拽排序
  - 空状态显示

**验收标准**:
- [x] 任务列表正确显示
- [x] 任务卡片样式符合设计
- [x] 完成/取消完成功能正常
- [ ] 拖拽排序功能正常（待实现）

---

### Task 2.3: 创建任务详情组件
**优先级**: 🔴 高  
**预估时间**: 4-5 小时  
**依赖**: Task 2.2

**任务内容**:
- 创建 `src/components/TodoDetail.tsx`
- 实现功能：
  - 标题编辑
  - 描述编辑
  - 日期时间选择器
  - 优先级选择器
  - 标签选择器（支持创建新标签）
  - 清单选择器
  - 重复规则设置
  - 子任务列表
  - 删除任务

**验收标准**:
- [x] 详情面板可以正常打开/关闭
- [x] 所有字段可以正常编辑
- [x] 日期时间选择器正常
- [x] 子任务功能正常（添加、完成/取消完成）

---

### Task 2.4: 创建快速添加任务组件
**优先级**: 🔴 高  
**预估时间**: 2-3 小时  
**依赖**: Task 1.3

**任务内容**:
- 创建 `src/components/QuickAddTodo.tsx`
- 实现功能：
  - 输入框（固定在底部或顶部）
  - 回车快速创建任务
  - 智能识别日期/时间/标签/优先级
  - 创建后清空输入框

**验收标准**:
- [x] 输入框正常显示
- [x] 回车创建任务正常
- [x] 智能识别功能正常
- [x] 创建后自动清空

---

## 📋 Phase 3: 视图模式实现

### Task 3.1: 实现列表视图
**优先级**: 🔴 高  
**预估时间**: 2-3 小时  
**依赖**: Task 2.2

**任务内容**:
- 在 `TodoList` 组件中实现列表视图
- 实现功能：
  - 按日期/优先级/标题排序
  - 筛选（已完成/未完成/全部）
  - 搜索功能
  - 任务分组显示（按日期）

**验收标准**:
- [x] 列表视图正确显示
- [x] 排序功能正常（支持按自定义、截止日期、优先级、创建时间、标题排序）
- [x] 筛选功能正常（支持按状态筛选：全部/待办/进行中/已完成）
- [x] 搜索功能正常（支持搜索任务标题、描述、标签）
- [x] 任务分组显示（按日期分组）
- [x] 拖拽排序功能正常（支持拖拽任务重新排序）

---

### Task 3.2: 实现日历视图
**优先级**: 🟡 中  
**预估时间**: 4-5 小时  
**依赖**: Task 2.2

**任务内容**:
- 创建 `src/components/TodoCalendar.tsx`
- 集成日历组件（如 `react-big-calendar` 或自定义）
- 实现功能：
  - 按月/周/日显示
  - 任务显示在对应日期
  - 拖拽任务到不同日期
  - 显示任务时间（如果有设置）
  - 点击日期快速添加任务

**验收标准**:
- [x] 日历视图正确显示
- [x] 任务正确显示在日期上
- [x] 拖拽功能正常（支持拖拽任务到不同日期）
- [x] 切换视图（月/周/日）正常
- [x] 点击日期快速添加任务

---

### Task 3.3: 实现看板视图
**优先级**: 🟡 中  
**预估时间**: 4-5 小时  
**依赖**: Task 2.2

**任务内容**:
- 创建 `src/components/TodoKanban.tsx`
- 使用 `@dnd-kit` 实现拖拽
- 实现功能：
  - 三列显示（待办/进行中/已完成）
  - 任务卡片显示关键信息
  - 拖拽任务在不同列间移动
  - 按清单/标签分组显示（可选）

**验收标准**:
- [x] 看板视图正确显示
- [x] 拖拽功能正常（支持拖拽任务在不同列间移动）
- [x] 任务状态正确更新
- [x] 卡片样式美观

---

### Task 3.4: 实现四象限视图
**优先级**: 🟡 中  
**预估时间**: 3-4 小时  
**依赖**: Task 2.2

**任务内容**:
- 创建 `src/components/TodoQuadrant.tsx`
- 实现功能：
  - 四个象限显示
  - 根据截止日期和优先级自动分类
  - 支持手动调整象限
  - 任务卡片显示

**验收标准**:
- [x] 四象限视图正确显示
- [x] 自动分类正确（根据截止日期和优先级自动分类）
- [x] 手动调整功能正常（支持拖拽任务到不同象限，自动调整优先级和截止日期）

---

## 📋 Phase 4: 高级功能实现

### Task 4.1: 实现智能识别功能
**优先级**: 🟡 中  
**预估时间**: 3-4 小时  
**依赖**: Task 1.3

**任务内容**:
- 完善 `parseTaskInput` 函数
- 实现日期时间识别：
  - 自然语言解析（"明天"、"下周一"等）
  - 日期格式解析（"3月15日"、"2025-01-15"等）
  - 时间解析（"下午3点"、"15:00"等）
- 实现标签识别：
  - "#标签名" 格式识别
  - 自动创建新标签
- 实现优先级识别：
  - "@重要"、"@高"、"@中"、"@低" 识别

**验收标准**:
- [x] 日期时间识别正确（支持自然语言、日期格式、时间解析）
- [x] 标签识别正确（#标签名格式）
- [x] 优先级识别正确（@重要/@高/@中/@低）
- [x] 识别后自动设置任务属性

---

### Task 4.2: 实现重复任务功能
**优先级**: 🟡 中  
**预估时间**: 4-5 小时  
**依赖**: Task 2.3

**任务内容**:
- 在 `TodoDetail` 组件中添加重复规则设置
- 实现重复规则：
  - 每日重复
  - 每周重复（可指定星期几）
  - 每月重复（可指定日期）
  - 每年重复
  - 自定义重复（每N天/周/月）
- 实现重复任务完成逻辑：
  - 完成任务时，根据重复规则创建下一个任务
  - 处理重复截止规则

**验收标准**:
- [x] 重复规则设置正常（每日/每周/每月/每年/自定义）
- [x] 完成任务时正确创建下一个任务（已集成到 completeTodo）
- [x] 重复截止规则正确处理（结束日期/重复次数）

---

### Task 4.3: 实现提醒通知功能
**优先级**: 🟡 中  
**预估时间**: 3-4 小时  
**依赖**: Task 2.3

**任务内容**:
- 创建 `src/lib/todo-reminder.ts`
- 实现提醒功能：
  - 使用 Web Notification API
  - 检查任务提醒时间
  - 定时器管理
  - 通知权限请求
- 在任务详情中设置提醒时间

**验收标准**:
- [x] 提醒通知正常显示（使用 Web Notification API）
- [x] 定时器正确工作（支持延迟提醒和定期检查）
- [x] 权限请求正常（自动请求通知权限）
- [x] 多个提醒正确处理（单例管理器管理所有提醒）

---

### Task 4.4: 实现子任务功能
**优先级**: 🟡 中  
**预估时间**: 3-4 小时  
**依赖**: Task 2.3

**任务内容**:
- 在 `TodoDetail` 组件中实现子任务列表
- 实现功能：
  - 添加子任务
  - 编辑子任务
  - 删除子任务
  - 完成/取消完成子任务
  - 子任务排序
  - 父任务完成时自动完成所有子任务（可选）

**验收标准**:
- [x] 子任务列表正确显示
- [x] 添加/编辑/删除子任务正常（双击编辑，删除按钮）
- [x] 子任务完成状态正确（支持切换完成状态）
- [x] 父任务完成时子任务自动完成（已完成，父任务完成时自动完成所有未完成的子任务）

---

### Task 4.5: 实现批量操作功能
**优先级**: 🟢 低  
**预估时间**: 3-4 小时  
**依赖**: Task 2.2

**任务内容**:
- 在 `TodoList` 组件中实现多选模式
- 实现功能：
  - 多选任务（复选框）
  - 批量完成
  - 批量删除
  - 批量移动清单
  - 批量设置标签
  - 批量设置优先级

**验收标准**:
- [x] 多选模式正常（支持全选/取消全选，显示选中数量）
- [x] 批量操作功能正常（批量完成、批量删除、批量移动清单、批量设置标签、批量设置优先级）
- [x] 操作后正确更新UI（操作后自动刷新列表）

---

## 📋 Phase 5: 清单管理

### Task 5.1: 实现清单管理功能
**优先级**: 🟡 中  
**预估时间**: 2-3 小时  
**依赖**: Task 2.1

**任务内容**:
- 创建 `src/components/TodoListSidebar.tsx`
- 实现功能：
  - 显示清单列表
  - 创建新清单
  - 编辑清单（名称、颜色、图标）
  - 删除清单
  - 设置默认清单
  - 清单排序

**验收标准**:
- [x] 清单列表正确显示
- [x] 创建/编辑/删除清单正常
- [x] 默认清单设置正常

---

### Task 5.2: 实现清单筛选功能
**优先级**: 🟡 中  
**预估时间**: 1-2 小时  
**依赖**: Task 5.1

**任务内容**:
- 在 `TodoManager` 中实现清单筛选
- 实现功能：
  - 点击清单显示该清单的任务
  - "全部"显示所有任务
  - "今天"显示今天的任务
  - "已完成"显示已完成的任务

**验收标准**:
- [x] 清单筛选功能正常（支持"全部"、"今天"、"已完成"筛选）
- [x] 切换清单时任务列表正确更新

---

## 📋 Phase 6: 数据统计

### Task 6.1: 实现统计功能
**优先级**: 🟢 低  
**预估时间**: 2-3 小时  
**依赖**: Task 2.1

**任务内容**:
- 创建 `src/components/TodoStats.tsx`
- 实现功能：
  - 今日完成数/总数
  - 本周完成数/总数
  - 本月完成数/总数
  - 完成率显示
  - 按优先级统计
  - 按标签统计

**验收标准**:
- [x] 统计数据正确显示（今日/本周/本月完成数、完成率、按优先级统计、按标签统计）
- [x] 统计实时更新（页面加载时自动加载统计数据）

---

## 📋 Phase 7: 搜索和筛选

### Task 7.1: 实现高级筛选功能
**优先级**: 🟡 中  
**预估时间**: 2-3 小时  
**依赖**: Task 2.2

**任务内容**:
- 创建 `src/components/TodoFilters.tsx`
- 实现功能：
  - 按状态筛选
  - 按优先级筛选
  - 按标签筛选
  - 按清单筛选
  - 按日期范围筛选
  - 组合筛选
  - 保存常用筛选（可选）

**验收标准**:
- [x] 筛选功能正常（按状态、优先级、标签、清单、日期范围筛选）
- [x] 组合筛选正确（支持多个筛选条件组合）
- [x] 筛选结果正确显示

---

### Task 7.2: 实现搜索功能
**优先级**: 🟡 中  
**预估时间**: 2-3 小时  
**依赖**: Task 2.2

**任务内容**:
- 在 `TodoManager` 中实现搜索
- 实现功能：
  - 搜索任务标题
  - 搜索任务描述
  - 搜索标签
  - 搜索结果高亮
  - 实时搜索（防抖）

**验收标准**:
- [x] 搜索功能正常（搜索任务标题、描述、标签）
- [x] 搜索结果正确（实时搜索，防抖300ms）
- [x] 关键词高亮正常（标题和描述中的关键词高亮显示）

---

## 📊 任务优先级总结

### 🔴 高优先级（核心功能）
1. Task 1.1: 创建数据库表结构
2. Task 1.2: 创建数据操作工具函数
3. Task 2.1: 创建任务管理主页面
4. Task 2.2: 创建任务列表组件
5. Task 2.3: 创建任务详情组件
6. Task 2.4: 创建快速添加任务组件
7. Task 3.1: 实现列表视图

### 🟡 中优先级（重要功能）
8. Task 1.3: 创建工具函数库
9. Task 3.2: 实现日历视图
10. Task 3.3: 实现看板视图
11. Task 3.4: 实现四象限视图
12. Task 4.1: 实现智能识别功能
13. Task 4.2: 实现重复任务功能
14. Task 4.3: 实现提醒通知功能
15. Task 4.4: 实现子任务功能
16. Task 5.1: 实现清单管理功能
17. Task 5.2: 实现清单筛选功能
18. Task 7.1: 实现高级筛选功能
19. Task 7.2: 实现搜索功能

### 🟢 低优先级（增强功能）
20. Task 4.5: 实现批量操作功能
21. Task 6.1: 实现统计功能

---

## 🎯 建议开发顺序

### MVP（最小可行产品）
完成以下任务即可发布基础版本：
1. Task 1.1 → Task 1.2 → Task 1.3（数据库和工具函数）
2. Task 2.1 → Task 2.2 → Task 2.3 → Task 2.4（基础 UI）
3. Task 3.1（列表视图）

### V1.0（完整功能）
在 MVP 基础上增加：
4. Task 3.2 → Task 3.3 → Task 3.4（所有视图）
5. Task 4.1 → Task 4.2 → Task 4.3 → Task 4.4（高级功能）
6. Task 5.1 → Task 5.2（清单管理）
7. Task 7.1 → Task 7.2（搜索筛选）

### V1.1（增强功能）
在 V1.0 基础上增加：
8. Task 4.5（批量操作）
9. Task 6.1（数据统计）

---

## 📝 注意事项

1. **数据迁移**：如果后续需要修改表结构，需要编写迁移脚本
2. **性能优化**：如果任务数量很多（>1000），考虑虚拟滚动和分页
3. **用户体验**：拖拽和快捷键需要充分测试，确保流畅
4. **移动端适配**：需要在实际设备上测试，模拟器可能不准确
5. **错误处理**：所有数据库操作都需要完善的错误处理
6. **类型安全**：使用 TypeScript 确保类型安全
7. **智能识别**：自然语言解析需要充分测试各种格式
8. **提醒通知**：需要考虑浏览器兼容性和权限管理

---

## 🔍 测试清单

每个任务完成后需要测试：
- [ ] 功能正常工作
- [ ] 错误处理正确
- [ ] 类型检查通过
- [ ] 移动端适配正常（如果涉及）
- [ ] 性能可接受
- [ ] UI 符合设计规范

